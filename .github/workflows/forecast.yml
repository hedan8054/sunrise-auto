name: Sunrise Forecast

on:
  schedule:
    # 每天北京时间 17:30 运行（UTC 09:30）
    - cron: '30 9 * * *'
  workflow_dispatch:

jobs:
  run-forecast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Run forecast
        run: python sunrise_bot.py forecast

      # 选出最新日出报告和当月日志，供邮件附件使用
      - name: Pick latest report
        id: pick
        shell: bash
        run: |
          # 关闭 -e 避免无文件时退出；用 nullglob 避免字面量通配符
          set +e
          shopt -s nullglob
      
          files=(out/forecast_*.txt)
          latest=""
          if (( ${#files[@]} )); then
            # 若有多个，取时间最新
            latest=$(ls -t out/forecast_*.txt | head -n 1)
            echo "latest=$latest" >> "$GITHUB_OUTPUT"
            echo "base=$(basename "$latest")" >> "$GITHUB_OUTPUT"
          fi
      
          YM=$(date +'%Y-%m')
          [ -f "logs/scores_${YM}.csv" ] && echo "scores=logs/scores_${YM}.csv" >> "$GITHUB_OUTPUT"
          [ -f "logs/cloud_${YM}.csv"  ] && echo "cloud=logs/cloud_${YM}.csv"  >> "$GITHUB_OUTPUT"
          [ -f "logs/calib_${YM}.csv"  ] && echo "calib=logs/calib_${YM}.csv"  >> "$GITHUB_OUTPUT"
      
          # 打印一下，方便排查
          echo "Picked latest: $latest"
          ls -al out || true
          ls -al logs || true

      # 读取报告并转成单行 HTML（换行-><br/>，转义 <>&）
      - name: Prepare email body (HTML)
        id: body
        if: ${{ steps.pick.outputs.latest != '' }}
        shell: bash
        run: |
          set -e
          FILE="${{ steps.pick.outputs.latest }}"
          HTML=$(python -c "import html,sys; t=open(r'$FILE','r',encoding='utf-8').read(); print(html.escape(t).replace('\n','<br/>'))")
          # 单行写入到 GITHUB_OUTPUT
          echo "html=${HTML}" >> "$GITHUB_OUTPUT"

      - name: Send email (sunrise)
        if: ${{ steps.pick.outputs.latest != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.QQ_SMTP_USER }}
          password: ${{ secrets.QQ_SMTP_PASS }}
          to: 248882568@qq.com
          from: Sunrise Auto <${{ secrets.QQ_SMTP_USER }}>
          subject: "日出预报 - ${{ steps.pick.outputs.base }}"
          content_type: text/html
          body: ${{ steps.body.outputs.html }}
          attachments: |
            ${{ steps.pick.outputs.latest }}
            ${{ steps.pick.outputs.scores }}
            ${{ steps.pick.outputs.cloud }}
            ${{ steps.pick.outputs.calib }}

      # 失败兜底：没产生日报或流程失败，发告警
      - name: Send failure email
        if: ${{ failure() || steps.pick.outputs.latest == '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.QQ_SMTP_USER }}
          password: ${{ secrets.QQ_SMTP_PASS }}
          to: 248882568@qq.com
          from: Sunrise Auto <${{ secrets.QQ_SMTP_USER }}>
          subject: "【告警】日出预报任务失败 - ${{ github.repository }}"
          body: |
            任务失败或未产生日出报告。
            仓库: ${{ github.repository }}
            分支: ${{ github.ref_name }}
            运行: ${{ github.run_id }}
            请在 Actions 查看日志。
